{% comment %}
Composant pour afficher du code avec coloration syntaxique et fonctionnalit√©s avanc√©es
Usage:
{% include code_block.html 
   title="Configuration Spring" 
   language="java" 
   file="src/main/java/config/FilterConfig.java"
   lines="1-20"
   highlight="5,10-12"
   show_copy=true %}
```java
// Votre code ici
```
{% endcode_block %}
{% endcomment %}

{% assign code_title = include.title %}
{% assign code_language = include.language | default: "text" %}
{% assign code_file = include.file %}
{% assign code_lines = include.lines %}
{% assign code_highlight = include.highlight %}
{% assign show_copy = include.show_copy | default: true %}
{% assign code_id = include.id | default: 'code-' | append: forloop.index | default: 1 %}

<div class="code-block" {% if code_id %}id="{{ code_id }}"{% endif %}>
    {% if code_title or code_file or show_copy %}
    <div class="code-header">
        <div class="code-info">
            {% if code_title %}
            <span class="code-title">{{ code_title }}</span>
            {% endif %}
            {% if code_file %}
            <span class="code-file">üìÑ {{ code_file }}</span>
            {% endif %}
            {% if code_lines %}
            <span class="code-lines">üìè Lignes {{ code_lines }}</span>
            {% endif %}
        </div>
        
        {% if show_copy %}
        <button class="copy-button" onclick="copyCode('{{ code_id }}')" title="Copier le code">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2"></rect>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"></path>
            </svg>
            <span class="copy-text">Copier</span>
        </button>
        {% endif %}
    </div>
    {% endif %}
    
    <div class="code-content">
        {% if code_highlight %}
        <div class="code-with-highlights" data-highlight="{{ code_highlight }}">
        {% endif %}
            {{ content }}
        {% if code_highlight %}
        </div>
        {% endif %}
    </div>
</div>

<script>
function copyCode(elementId) {
    const codeBlock = document.getElementById(elementId);
    const codeContent = codeBlock.querySelector('code, pre');
    const button = codeBlock.querySelector('.copy-button');
    
    if (codeContent) {
        const text = codeContent.textContent || codeContent.innerText;
        
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                showCopyFeedback(button, true);
            }).catch(() => {
                fallbackCopyTextToClipboard(text, button);
            });
        } else {
            fallbackCopyTextToClipboard(text, button);
        }
    }
}

function fallbackCopyTextToClipboard(text, button) {
    const textArea = document.createElement("textarea");
    textArea.value = text;
    textArea.style.position = "fixed";
    textArea.style.left = "-999999px";
    textArea.style.top = "-999999px";
    document.body.appendChild(textArea);
    textArea.focus();
    textArea.select();
    
    try {
        const successful = document.execCommand('copy');
        showCopyFeedback(button, successful);
    } catch (err) {
        showCopyFeedback(button, false);
    }
    
    document.body.removeChild(textArea);
}

function showCopyFeedback(button, success) {
    const originalText = button.querySelector('.copy-text').textContent;
    const feedbackText = success ? 'Copi√© !' : 'Erreur';
    
    button.classList.add(success ? 'copy-success' : 'copy-error');
    button.querySelector('.copy-text').textContent = feedbackText;
    
    setTimeout(() => {
        button.classList.remove('copy-success', 'copy-error');
        button.querySelector('.copy-text').textContent = originalText;
    }, 2000);
}

// Highlight des lignes sp√©cifiques
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.code-with-highlights').forEach(function(block) {
        const highlightData = block.getAttribute('data-highlight');
        if (highlightData) {
            const lines = parseHighlightData(highlightData);
            highlightLines(block, lines);
        }
    });
});

function parseHighlightData(data) {
    const lines = [];
    const parts = data.split(',');
    
    parts.forEach(part => {
        part = part.trim();
        if (part.includes('-')) {
            const [start, end] = part.split('-').map(n => parseInt(n.trim()));
            for (let i = start; i <= end; i++) {
                lines.push(i);
            }
        } else {
            lines.push(parseInt(part));
        }
    });
    
    return lines;
}

function highlightLines(block, lineNumbers) {
    const pre = block.querySelector('pre');
    if (!pre) return;
    
    const code = pre.querySelector('code') || pre;
    const lines = code.innerHTML.split('\n');
    
    const highlightedLines = lines.map((line, index) => {
        const lineNumber = index + 1;
        if (lineNumbers.includes(lineNumber)) {
            return `<span class="highlighted-line">${line}</span>`;
        }
        return line;
    });
    
    code.innerHTML = highlightedLines.join('\n');
}
</script>

<style>
.code-block {
    margin: 1.5rem 0;
    border-radius: 8px;
    overflow: hidden;
    border: 1px solid var(--color-border);
    background: var(--color-bg-secondary);
}

.code-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0.75rem 1rem;
    background: rgba(0, 0, 0, 0.05);
    border-bottom: 1px solid var(--color-border);
    font-size: 0.9rem;
}

.code-info {
    display: flex;
    align-items: center;
    gap: 1rem;
    flex-wrap: wrap;
}

.code-title {
    font-weight: 600;
    color: var(--color-text-primary);
}

.code-file, .code-lines {
    color: var(--color-text-secondary);
    font-size: 0.85rem;
}

.copy-button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.5rem;
    background: transparent;
    border: 1px solid var(--color-border);
    border-radius: 4px;
    color: var(--color-text-secondary);
    cursor: pointer;
    transition: all 0.2s ease;
    font-size: 0.85rem;
}

.copy-button:hover {
    background: var(--color-accent);
    color: white;
    border-color: var(--color-accent);
}

.copy-button.copy-success {
    background: #10b981;
    color: white;
    border-color: #10b981;
}

.copy-button.copy-error {
    background: #ef4444;
    color: white;
    border-color: #ef4444;
}

.code-content {
    overflow-x: auto;
}

.code-content pre {
    margin: 0;
    padding: 1rem;
    background: transparent;
    overflow-x: auto;
}

.code-content code {
    background: transparent;
    padding: 0;
    border-radius: 0;
    color: inherit;
}

.highlighted-line {
    background: rgba(255, 255, 0, 0.2);
    display: block;
    margin: 0 -1rem;
    padding: 0 1rem;
    position: relative;
}

.highlighted-line::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 4px;
    background: var(--color-accent);
}

@media (max-width: 768px) {
    .code-header {
        flex-direction: column;
        align-items: flex-start;
        gap: 0.5rem;
    }
    
    .copy-button .copy-text {
        display: none;
    }
}

@media (prefers-color-scheme: dark) {
    .code-header {
        background: rgba(255, 255, 255, 0.05);
    }
    
    .highlighted-line {
        background: rgba(255, 255, 0, 0.1);
    }
}
</style>